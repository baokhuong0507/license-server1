{% extends "base.html" %}

{% block title %}Quản lý Keys{% endblock %}

{% block content %}
    <!-- CÁC FORM GIỮ NGUYÊN -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: start; margin-bottom: 2rem;">
        <!-- ... (Nội dung của hai form thêm key) ... -->
        <div>
            <h2>Thêm Key Thủ Công</h2>
            <form action="/admin/add-key" method="post">
                <div class="form-group">
                    <label for="key_value">Giá trị Key:</label>
                    <input type="text" name="key_value" id="key_value" placeholder="Nhập key thủ công..." required>
                </div>
                <div class="form-group">
                    <label for="program_name_single">Tên chương trình (Mặc định: 'Default'):</label>
                    <input type="text" name="program_name" id="program_name_single" value="Default">
                </div>
                <div class="form-group">
                    <label for="expiration_date_single">Hạn dùng (để trống nếu vĩnh viễn):</label>
                    <input type="date" name="expiration_date_str" id="expiration_date_single">
                </div>
                <button type="submit">Thêm Key</button>
            </form>
        </div>
        <div>
            <h2>Tạo Key Hàng Loạt</h2>
            <form action="/admin/bulk-add-keys" method="post">
                <div class="form-group">
                    <label for="quantity">Số lượng (1-100):</label>
                    <input type="number" name="quantity" id="quantity" value="10" min="1" max="100">
                </div>
                <div class="form-group">
                    <label for="length">Độ dài (8-50):</label>
                    <input type="number" name="length" id="length" value="20" min="8" max="50">
                </div>
                <div class="form-group">
                    <label for="program_name_bulk">Tên chương trình (Mặc định: 'Default'):</label>
                    <input type="text" name="program_name" id="program_name_bulk" value="Default">
                </div>
                <div class="form-group">
                    <label for="expiration_date_bulk">Hạn dùng (để trống nếu vĩnh viễn):</label>
                    <input type="date" name="expiration_date_str" id="expiration_date_bulk">
                </div>
                <button type="submit">Tạo Hàng Loạt</button>
            </form>
        </div>
    </div>
    <hr style="margin: 2rem 0;">
    <h2>Bộ lọc và Tìm kiếm</h2>
    <form action="/admin/dashboard" method="get" style="display: flex; gap: 1rem; align-items: flex-end; margin-bottom: 1rem; flex-wrap: wrap;">
        <!-- ... (Nội dung của form lọc) ... -->
        <div>
            <label for="status_filter">Trạng thái:</label>
            <select name="status" id="status_filter">
                <option value="">Tất cả</option>
                <option value="active" {% if filters.status == 'active' %}selected{% endif %}>Sẵn dùng</option>
                <option value="used" {% if filters.status == 'used' %}selected{% endif %}>Đã dùng</option>
                <option value="revoked" {% if filters.status == 'revoked' %}selected{% endif %}>Đã khóa</option>
                <option value="expired" {% if filters.status == 'expired' %}selected{% endif %}>Hết hạn</option>
            </select>
        </div>
        <div>
            <label for="program_filter">Tên chương trình:</label>
            <input type="text" name="program" id="program_filter" value="{{ filters.program_name or '' }}">
        </div>
        <div>
            <label for="search_filter">Tìm Key:</label>
            <input type="text" name="search" id="search_filter" value="{{ filters.search_key or '' }}">
        </div>
        <button type="submit">Lọc</button>
        <a href="/admin/dashboard" style="text-decoration: none; padding: 8px 12px; background: #6c757d; color: white; border-radius: 4px; line-height: 1.5;">Reset</a>
    </form>
    
    <h2>Danh sách Keys <span id="loading-indicator" style="font-size: 0.8em; color: grey; display: none;">(Đang cập nhật...)</span></h2>
    <div style="overflow-x: auto;">
        <table id="keys-table"> <!-- Thêm ID cho bảng -->
            <thead>
                <tr>
                    <th>License Key</th>
                    <th>Tên chương trình</th>
                    <th>Trạng thái</th>
                    <th>Hạn dùng</th>
                    <th>ID Máy tính</th>
                    <th>Người dùng</th>
                    <th>Số lần kích hoạt</th>
                    <th>Lần dùng cuối</th> <!-- CỘT MỚI -->
                    <th>Cảnh báo</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="keys-table-body"> <!-- Thêm ID cho tbody -->
                {% include 'partials/keys_table_rows.html' %} <!-- Tách nội dung bảng ra file riêng -->
            </tbody>
        </table>
    </div>

    <!-- KHỐI MÃ JAVASCRIPT MỚI -->
    <script>
        const statusMap = {
            'active': 'Sẵn dùng',
            'used': 'Đã dùng',
            'revoked': 'Đã khóa',
            'expired': 'Hết hạn'
        };

        function timeAgo(date) {
            if (!date) return 'Chưa dùng';
            const seconds = Math.floor((new Date() - new Date(date)) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return Math.floor(interval) + " năm trước";
            interval = seconds / 2592000;
            if (interval > 1) return Math.floor(interval) + " tháng trước";
            interval = seconds / 86400;
            if (interval > 1) return Math.floor(interval) + " ngày trước";
            interval = seconds / 3600;
            if (interval > 1) return Math.floor(interval) + " giờ trước";
            interval = seconds / 60;
            if (interval > 1) return Math.floor(interval) + " phút trước";
            return Math.floor(seconds) + " giây trước";
        }

        async function fetchAndUpdateKeys() {
            document.getElementById('loading-indicator').style.display = 'inline';
            try {
                // Lấy access token từ cookie để xác thực
                const token = document.cookie.split('; ').find(row => row.startsWith('access_token=')).split('=')[1];
                
                const response = await fetch('/api/admin/keys/all', {
                    headers: { 'X-Admin-Secret': token } // Dùng token thay cho secret key
                });

                if (response.status === 401) {
                    // Nếu token hết hạn, chuyển hướng về trang đăng nhập
                    window.location.href = '/admin/login';
                    return;
                }

                const keys = await response.json();
                const tableBody = document.getElementById('keys-table-body');
                
                // Lưu lại các key đang hiển thị để so sánh
                const currentKeys = new Set([...tableBody.querySelectorAll('tr')].map(tr => tr.dataset.keyValue));
                const newKeys = new Set(keys.map(k => k.key_value));
                
                // Chỉ cập nhật nếu có sự thay đổi về số lượng key
                if (currentKeys.size !== newKeys.size) {
                    // Nếu có thay đổi lớn, tải lại cả trang để giữ bộ lọc
                    window.location.reload();
                    return;
                }

                // Cập nhật từng dòng
                keys.forEach(key => {
                    const row = tableBody.querySelector(`tr[data-key-value="${key.key_value}"]`);
                    if (row) {
                        // Cập nhật các ô có thể thay đổi
                        row.querySelector('.status').innerHTML = `<span style="font-weight: bold; color: ${key.status === 'used' ? 'green' : (key.status === 'revoked' ? 'orange' : (key.status === 'expired' ? 'grey' : 'black'))};">${statusMap[key.status] || key.status}</span>`;
                        row.querySelector('.last-activated').textContent = timeAgo(key.last_activated_at);
                        row.querySelector('.failed-attempts').textContent = key.failed_attempts || 0;
                        
                        const warningCell = row.querySelector('.warning');
                        if (key.failed_attempts > 3) {
                            warningCell.innerHTML = `<span style="color: red; font-weight: bold;">Bị chia sẻ! (${key.failed_attempts} lần thử)</span>`;
                        } else {
                            warningCell.textContent = 'Không có';
                        }
                    }
                });
            } catch (error) {
                console.error('Lỗi khi cập nhật keys:', error);
            } finally {
                document.getElementById('loading-indicator').style.display = 'none';
            }
        }

        // Tự động cập nhật mỗi 10 giây
        setInterval(fetchAndUpdateKeys, 10000);
    </script>
{% endblock %}